import{_ as me,a as fe}from"./DKItBGiq.js";import{_ as _e}from"./_9ZTpig7.js";import{_ as pe,a as ve}from"./C8qUqt0S.js";import{d as ye,Y as ge,$ as w,N as he,z as A,a0 as be,v as xe,I as X,c,o as d,a as f,g as b,w as $,X as C,a1 as L,j as N,e as Y,t as _,a2 as $e,p as z,f as q,F as U,n as ae,a3 as ke}from"#entry";import{_ as Se}from"./CFo5vVrQ.js";import{_ as Ne}from"./DRvGcOf2.js";import{u as we}from"./DlX1qgfK.js";import{u as Ce}from"./B0tHT99O.js";import{u as Ve}from"./CYZtsaz0.js";import{u as Fe}from"./Ba5Lnm1G.js";import{u as Ue}from"./LcPdVSvu.js";import{u as Te}from"./C87MT8_t.js";import{u as Ee}from"./DZ2uQVpg.js";import{n as Be}from"./Bgk1oRip.js";import"./DpB_hE1g.js";import"./DYXxPDVW.js";import"./bPUzXHqf.js";const Me={class:"space-y-6"},Pe={class:"flex justify-between items-center"},je={key:0},Ae={class:"text-xl font-semibold mb-2"},Le={class:"text-lg font-semibold"},ze={class:"text-sm text-gray-500"},qe={key:0,class:"font-semibold text-center"},Ge={key:1,class:"font-medium"},Re={key:2,class:"text-center"},We={key:0,class:"flex flex-col items-center gap-1"},De={class:"font-semibold text-gray-400"},He={class:"mt-1 text-left text-xs w-full border-t border-gray-200 pt-1"},Ke={class:"truncate"},Oe={class:"text-xs text-right text-gray-500 pt-1"},Qe={key:0,class:"font-semibold text-center"},Xe={key:1,class:"font-medium"},Ye={key:2,class:"text-center"},Je={key:0,class:"flex flex-col items-center gap-1"},Ze={class:"font-semibold text-gray-400"},Ie={class:"mt-1 text-left text-xs w-full border-t border-gray-200 pt-1"},et={class:"truncate"},tt={class:"text-xs text-right text-gray-500 pt-1"},nt={class:"flex justify-end mt-4"},st={key:1,class:"text-gray-500 italic text-sm text-center p-4 border rounded-md bg-gray-50"},ot={key:1,class:"text-gray-500 italic p-4"},kt=ye({__name:"index",setup(at){ge({title:"Scores"});const J=we(),{loggedInUser:Z}=w(J),T=Ce(),{scores:I}=w(T),ee=Ve(),{contestants:V}=w(ee),te=Fe(),{categories:M}=w(te),ne=Ue(),{criteria:x}=w(ne),G=Te(),{events:R}=w(G),W=Ee(),{phases:D}=w(W),se=he(),S=A(null),E=A(!1),m=A({}),B=A({}),ie=n=>{if(String(n?.slug||"").toLowerCase()==="q-and-a")return!0;const o=String(n?.name||"");return/(^|\s)q\s*&?\s*a(\s|$)/i.test(o)},re=n=>n?.toLowerCase()==="female"?"female":"male";be(async()=>{await Promise.all([G.fetchEvents(),J.fetchLoggedInUser()]),await G.fetchEvents(),R.value?.length&&(S.value=R.value[0].id),await W.fetchPhasesByEvent(S.value),console.log("âœ… Logged-in user:",Z.value)});let H=null;function le(n){const e=[],o=(s,t=null,i=null)=>{const u={...s,category_id:s.category_id??t,parent_id:s.parent_id??i};if(e.push(u),Array.isArray(s.children)&&s.children.length)for(const a of s.children)o(a,u.category_id,u.id)};for(const s of n||[])o(s);return e}const k=xe(()=>{const n={};for(const e of x.value||[])n[e.id]={...e};for(const e of Object.values(n))if(e.parent_id&&(!e.category_id||e.category_id===null)){const o=n[e.parent_id];o&&(e.category_id=o.category_id)}return n}),F=(n,e)=>{const o=k.value[e];if(!o||!o.children?.length)return{subtotal:0,weighted:0};const s=o.children.reduce((i,u)=>{const a=m.value[`${n}-${u.id}`],g=a===""||a===null||a===void 0?0:Number(a);return isNaN(g)?i:i+g*(Number(u.percentage)/100)},0),t=s*Number(o.percentage)/100;return{subtotal:s,weighted:t}},de=(n,e)=>{const o=F(n,e),s=Number(o.weighted||0);return isNaN(s)?0:s},P=n=>{const e=x.value||[],o=new Set;for(const t of e)if(Array.isArray(t.children)&&t.children.length)for(const i of t.children)i?.id!=null&&o.add(Number(i.id));const s=e.filter(t=>t.category_id===n.id&&!o.has(Number(t.id)));return[{key:"number",label:"No."},{key:"municipality",label:"Municipality"},...s.map(t=>({key:`crit_${t.id}`,label:`${t.name} (${Number(t.percentage)}%)`,raw:!0})),{key:"total",label:"Total"}]},K=(n,e)=>{const o=(V.value||[]).filter(a=>(a.gender||"").toLowerCase()===e.toLowerCase()),s=a=>({id:a.id,number:a.number,municipality:a.municipality??a.lgu??a.lgu_name??""});if(!ie(n))return o.map(s);const t=re(e),i=T.finalists?.[t]??[];if(!i.length)return[];const u=i.map(a=>a.contestant_id);return o.filter(a=>u.includes(a.id)).map(s)},O=(n,e)=>x.value.filter(t=>t.category_id===e).reduce((t,i)=>{if(i.children?.length)return t+de(n,i.id);if(!i.parent_id){const u=`${n}-${i.id}`,a=Number(m.value[u]||0);return t+a*(Number(i.percentage)/100)}return t},0).toFixed(5),oe=Be({required_error:"Score is required",invalid_type_error:"Must be a number"}).min(60,{message:"Minimum is 60"}).max(100,{message:"Maximum is 100"}),ue=n=>{if(!x.value?.length||!V.value?.length)return!1;const e=x.value.filter(o=>{const s=x.value.some(u=>u.parent_id===o.id),t=o.parent_id?k.value[o.parent_id]:null;return(o.category_id===n||t?.category_id===n)&&!s});if(!e.length)return!1;for(const o of e){const s=["male","female"];for(const t of s){K(n,t);for(const i of V.value){const u=`${i.id}-${o.id}`,a=m.value[u];if(a==null||a==="")return!1;const g=Number(a);if(isNaN(g)||!oe.safeParse(g).success)return!1}}}return!0},ce=async n=>{if(S.value){E.value=!0;try{const e=x.value.filter(t=>{const i=x.value.some(g=>g.parent_id===t.id),u=t.parent_id?k.value[t.parent_id]:null;return(t.category_id===n.id||u?.category_id===n.id)&&!i}),o=[],s=[];for(const t of e)for(const i of V.value||[]){const u=`${i.id}-${t.id}`,a=m.value[u];if(a==null||a==="")continue;const g=Number(a);if(isNaN(g))continue;if(!oe.safeParse(g).success){s.push(`${i.name} (${t.name})`);continue}o.push({contestant_id:i.id,criterion_id:t.id,category_id:t.category_id,judge_id:Z.value?.id,score:g})}if(s.length>0){se.add({title:"Invalid Scores",description:`Please check these entries:
${s.join(", ")}`,color:"red"});return}await T.bulkAddScores({event_id:S.value,scores:o}),se.add({title:`Scores for "${n.name}" saved successfully`,color:"green"})}finally{E.value=!1}}};return X(m,(n,e)=>{const o=(x.value||[]).filter(s=>s.children?.length);for(const s of o)for(const t of V.value||[]){const{subtotal:i,weighted:u}=F(t.id,s.id);if(!isFinite(u))continue;const a=`${t.id}-${s.id}`;m.value[a]=Number(u.toFixed(5))}},{deep:!0,immediate:!0}),X(m,()=>{H&&clearTimeout(H),H=setTimeout(()=>{const n={};for(const e of M.value||[])for(const o of V.value||[]){const s=O(o.id,e.id);n[`${o.id}-${e.id}`]=Number(s)}B.value=n},100)},{deep:!0}),X(S,async n=>{if(n){E.value=!0;try{await Promise.all([W.fetchPhasesByEvent(n),te.fetchCategoriesByEvent(n),ne.fetchCriteriaByEvent?.(n),ee.fetchContestantsByEvent?.(n),T.fetchScoresByEvent?.(n)]),await T.fetchFinalists({event_id:n,limit:5,category_slugs:["ethnic-wear","casual-interview","advocacy-pitch","swim-wear","talent","creative-wear","formal-wear"]}),x.value=le(x.value||[]),m.value={};for(const e of I.value)m.value[`${e.contestant_id}-${e.criterion_id}`]=e.score}finally{E.value=!1,I.value?.length||(m.value={})}}}),(n,e)=>{const o=me,s=_e,t=ve,i=fe,u=ke,a=Se,g=pe,j=Ne;return d(),c("div",Me,[f("div",Pe,[b(s,{label:"Select Active Event"},{default:$(()=>[b(o,{modelValue:S.value,"onUpdate:modelValue":e[0]||(e[0]=h=>S.value=h),options:C(R).map(h=>({label:h.title,value:h.id})),placeholder:"Choose event",class:"w-72"},null,8,["modelValue","options"])]),_:1})]),S.value&&C(D)?.length?(d(),c("div",je,[b(j,{items:C(D).map(h=>({label:h.name,icon:"i-heroicons-flag",slot:`phase-${h.id}`}))},L({_:2},[N(C(D),h=>({name:`phase-${h.id}`,fn:$(()=>[b(a,{class:"p-4 space-y-6"},{default:$(()=>[f("div",Ae,_(h.name),1),C(M).filter(r=>r.phase_id===h.id).length?(d(),Y(j,{key:0,items:C(M).filter(r=>r.phase_id===h.id).map(r=>({label:`${r.name} (${r.weight}%)`,icon:"i-heroicons-sparkles",slot:`category-${r.id}`}))},L({_:2},[N(C(M).filter(r=>r.phase_id===h.id),r=>({name:`category-${r.id}`,fn:$(()=>[b(g,{state:m.value,onSubmit:$e(()=>ce(r),["prevent"]),class:"space-y-4"},{default:$(()=>[b(a,{class:"p-4 space-y-4"},{default:$(()=>[f("div",Le,[z(_(r.name)+" ",1),f("span",ze,"("+_(r.weight)+"%)",1)]),f("div",null,[e[2]||(e[2]=f("div",{class:"font-medium mt-2 mb-2 text-pink-500"},"Female",-1)),b(i,{columns:P(r),rows:K(r,"female")},L({_:2},[N(P(r),p=>({name:p.key+"-data",fn:$(({row:l})=>[p.key==="number"?(d(),c("div",qe,_(l.number),1)):p.key==="municipality"?(d(),c("div",Ge,_(l.municipality),1)):p.key.startsWith("crit_")?(d(),c("div",Re,[b(s,{name:`${l.id}-${Number(p.key.split("_")[1])}`},{default:$(()=>[k.value[Number(p.key.split("_")[1])]?(d(!0),c(U,{key:0},N([Number(p.key.split("_")[1])],v=>(d(),c(U,{key:v},[k.value[v]?.children?.length?(d(),c("div",We,[f("div",De,_(F(l.id,v).weighted.toFixed(5)),1),f("div",He,[(d(!0),c(U,null,N(k.value[v].children,y=>(d(),c("div",{key:y.id,class:"flex items-center justify-between gap-2 py-0.5"},[f("span",Ke,_(y.name)+" ("+_(y.percentage)+"%)",1),b(t,{modelValue:m.value[`${l.id}-${y.id}`],"onUpdate:modelValue":Q=>m.value[`${l.id}-${y.id}`]=Q,type:"number",step:"0.1",size:"2xs",class:"w-20 text-center"},null,8,["modelValue","onUpdate:modelValue"])]))),128)),f("div",Oe,[e[1]||(e[1]=z(" Subtotal: ",-1)),f("b",null,_(F(l.id,v).subtotal.toFixed(5)),1)])])])):(d(),Y(t,{key:1,modelValue:m.value[`${l.id}-${v}`],"onUpdate:modelValue":y=>m.value[`${l.id}-${v}`]=y,type:"number",step:"0.1",size:"xs",class:"w-20 text-center"},null,8,["modelValue","onUpdate:modelValue"]))],64))),128)):q("",!0)]),_:2},1032,["name"])])):p.key==="total"?(d(),c("div",{key:3,class:ae(["text-right font-semibold transition-all duration-300",{"text-green-600":B.value[`${l.id}-${r.id}`]!==void 0}])},_(B.value[`${l.id}-${r.id}`]?.toFixed(5)??O(l.id,r.id)),3)):q("",!0)])}))]),1032,["columns","rows"])]),f("div",null,[e[4]||(e[4]=f("div",{class:"font-medium mt-2 mb-2 text-blue-500"},"Male",-1)),b(i,{columns:P(r),rows:K(r,"male")},L({_:2},[N(P(r),p=>({name:p.key+"-data",fn:$(({row:l})=>[p.key==="number"?(d(),c("div",Qe,_(l.number),1)):p.key==="municipality"?(d(),c("div",Xe,_(l.municipality),1)):p.key.startsWith("crit_")?(d(),c("div",Ye,[b(s,{name:`${l.id}-${Number(p.key.split("_")[1])}`},{default:$(()=>[k.value[Number(p.key.split("_")[1])]?(d(!0),c(U,{key:0},N([Number(p.key.split("_")[1])],v=>(d(),c(U,{key:v},[k.value[v]?.children?.length?(d(),c("div",Je,[f("div",Ze,_(F(l.id,v).weighted.toFixed(5)),1),f("div",Ie,[(d(!0),c(U,null,N(k.value[v].children,y=>(d(),c("div",{key:y.id,class:"flex items-center justify-between gap-2 py-0.5"},[f("span",et,_(y.name)+" ("+_(y.percentage)+"%)",1),b(t,{modelValue:m.value[`${l.id}-${y.id}`],"onUpdate:modelValue":Q=>m.value[`${l.id}-${y.id}`]=Q,type:"number",step:"0.1",size:"2xs",class:"w-20 text-center"},null,8,["modelValue","onUpdate:modelValue"])]))),128)),f("div",tt,[e[3]||(e[3]=z(" Subtotal: ",-1)),f("b",null,_(F(l.id,v).subtotal.toFixed(5)),1)])])])):(d(),Y(t,{key:1,modelValue:m.value[`${l.id}-${v}`],"onUpdate:modelValue":y=>m.value[`${l.id}-${v}`]=y,type:"number",step:"0.1",size:"xs",class:"w-20 text-center"},null,8,["modelValue","onUpdate:modelValue"]))],64))),128)):q("",!0)]),_:2},1032,["name"])])):p.key==="total"?(d(),c("div",{key:3,class:ae(["text-right font-semibold transition-all duration-300",{"text-green-600":B.value[`${l.id}-${r.id}`]!==void 0}])},_(B.value[`${l.id}-${r.id}`]?.toFixed(5)??O(l.id,r.id)),3)):q("",!0)])}))]),1032,["columns","rows"])]),f("div",nt,[b(u,{type:"submit",color:"primary",icon:"i-heroicons-check-circle",loading:E.value,disabled:!ue(r.id)},{default:$(()=>[z(" Save Scores for "+_(r.name),1)]),_:2},1032,["loading","disabled"])])]),_:2},1024)]),_:2},1032,["state","onSubmit"])])}))]),1032,["items"])):(d(),c("div",st," No categories found under this phase. "))]),_:2},1024)])}))]),1032,["items"])])):(d(),c("div",ot," Please select an event to begin scoring. "))])}}});export{kt as default};

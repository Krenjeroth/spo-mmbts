import{R as y,P as E,S as C,ae as A,v as H,af as x,ag as R,W as T,a6 as k,Q as c}from"#entry";import{u as I}from"./bPUzXHqf.js";function h(e){return e.length>1&&e.slice(-1)==="/"?e.slice(0,-1):e}const P=()=>{const e=y(),s=E(),u=I(),t=C(),r=A(),d=H(()=>s.value!==null),w=x(R,()=>!1);async function p(){w.value||(w.value=!0,await f(),await e.callHook("sanctum:init"))}async function f(){s.value=await u(t.endpoints.user),await e.callHook("sanctum:refresh")}async function v(i,l=!0){const n=k(),g=h(n.path);if(d.value){if(!t.redirectIfAuthenticated)throw new Error("User is already authenticated");if(t.redirect.onLogin===!1||t.redirect.onLogin===g)return;if(t.redirect.onLogin===void 0)throw new Error("`sanctum.redirect.onLogin` is not defined");const o=t.redirect.onLogin;await e.callHook("sanctum:redirect",o),await e.runWithContext(async()=>await c(o))}if(t.endpoints.login===void 0)throw new Error("`sanctum.endpoints.login` is not defined");const a=await u(t.endpoints.login,{method:"post",body:i});if(t.mode==="token"){if(r.tokenStorage===void 0)throw new Error("`sanctum.tokenStorage` is not defined in app.config.ts");if(a.token===void 0)throw new Error("Token was not returned from the API");await r.tokenStorage.set(e,a.token)}if(l&&await f(),await e.callHook("sanctum:login"),t.redirect.keepRequestedRoute){const o=n.query.redirect;if(o&&o!==g)return await e.callHook("sanctum:redirect",o),await e.runWithContext(async()=>await c(o)),a}if(t.redirect.onLogin===!1||n.path===t.redirect.onLogin)return a;if(t.redirect.onLogin===void 0)throw new Error("`sanctum.redirect.onLogin` is not defined");const m=t.redirect.onLogin;return await e.callHook("sanctum:redirect",m),await e.runWithContext(async()=>await c(m)),a}async function L(){if(!d.value)throw new Error("User is not authenticated");const i=k(),l=h(i.path);if(t.endpoints.logout===void 0)throw new Error("`sanctum.endpoints.logout` is not defined");if(await u(t.endpoints.logout,{method:"post"}),s.value=null,await e.callHook("sanctum:logout"),t.mode==="token"){if(r.tokenStorage===void 0)throw new Error("`sanctum.tokenStorage` is not defined in app.config.ts");await r.tokenStorage.set(e,void 0)}if(t.redirect.onLogout===!1||l===t.redirect.onLogout)return;if(t.redirect.onLogout===void 0)throw new Error("`sanctum.redirect.onLogout` is not defined");const n=t.redirect.onLogout;await e.callHook("sanctum:redirect",n),await e.runWithContext(async()=>await c(n))}async function S(){return!(t.mode=="cookie"&&!T(t.csrf.cookie,{readonly:!0}).value||t.mode=="token"&&!await r.tokenStorage.get(e))}return{user:s,isAuthenticated:d,init:p,login:v,logout:L,refreshIdentity:f,checkSession:S}};export{h as t,P as u};

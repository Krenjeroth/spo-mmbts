import{_ as me,a as fe}from"./D3Dcj_v8.js";import{_ as _e}from"./BSWBmhT_.js";import{_ as pe,a as ve}from"./Bd0EK6v7.js";import{d as ye,Y as ge,$ as C,N as he,z as A,a0 as be,v as xe,I as X,c,o as d,e as f,g as b,w as $,X as V,a1 as L,j as w,b as Y,t as _,a2 as $e,p as z,f as q,F as U,n as ae,a3 as ke}from"#entry";import{_ as Se}from"./BHpSMavt.js";import{_ as Ne}from"./DpIK6lhX.js";import{u as we}from"./gsBbaiaa.js";import{u as Ce}from"./B0mFkXpW.js";import{u as Ve}from"./BdHKa--D.js";import{u as Fe}from"./D6l_iJzJ.js";import{u as Ue}from"./EYerQBAz.js";import{u as Te}from"./2jTwVr-P.js";import{u as Ee}from"./yF1_bWGY.js";import{n as Be}from"./Bgk1oRip.js";import"./DpB_hE1g.js";import"./DYXxPDVW.js";import"./bPUzXHqf.js";const Me={class:"space-y-6"},Pe={class:"flex justify-between items-center"},je={key:0},Ae={class:"text-xl font-semibold mb-2"},Le={class:"text-lg font-semibold"},ze={class:"text-sm text-gray-500"},qe={key:0,class:"font-semibold text-center"},Ge={key:1,class:"font-medium"},Re={key:2,class:"text-center"},We={key:0,class:"flex flex-col items-center gap-1"},De={class:"font-semibold text-gray-400"},He={class:"mt-1 text-left text-xs w-full border-t border-gray-200 pt-1"},Ke={class:"truncate"},Oe={class:"text-xs text-right text-gray-500 pt-1"},Qe={key:0,class:"font-semibold text-center"},Xe={key:1,class:"font-medium"},Ye={key:2,class:"text-center"},Je={key:0,class:"flex flex-col items-center gap-1"},Ze={class:"font-semibold text-gray-400"},Ie={class:"mt-1 text-left text-xs w-full border-t border-gray-200 pt-1"},et={class:"truncate"},tt={class:"text-xs text-right text-gray-500 pt-1"},nt={class:"flex justify-end mt-4"},st={key:1,class:"text-gray-500 italic text-sm text-center p-4 border rounded-md bg-gray-50"},ot={key:1,class:"text-gray-500 italic p-4"},kt=ye({__name:"index",setup(at){ge({title:"Scores"});const J=we(),{loggedInUser:Z}=C(J),T=Ce(),{scores:I}=C(T),ee=Ve(),{contestants:P}=C(ee),te=Fe(),{categories:E}=C(te),ne=Ue(),{criteria:x}=C(ne),G=Te(),{events:R}=C(G),W=Ee(),{phases:D}=C(W),se=he(),S=A(null),B=A(!1),m=A({}),M=A({}),ie=n=>{if(String(n?.slug||"").toLowerCase()==="q-and-a")return!0;const o=String(n?.name||"");return/(^|\s)q\s*&?\s*a(\s|$)/i.test(o)},re=n=>n?.toLowerCase()==="female"?"female":"male";be(async()=>{await Promise.all([G.fetchEvents(),J.fetchLoggedInUser()]),await G.fetchEvents(),R.value?.length&&(S.value=R.value[0].id),await W.fetchPhasesByEvent(S.value),console.log("âœ… Logged-in user:",Z.value)});let H=null;function le(n){const t=[],o=(s,e=null,i=null)=>{const u={...s,category_id:s.category_id??e,parent_id:s.parent_id??i};if(t.push(u),Array.isArray(s.children)&&s.children.length)for(const a of s.children)o(a,u.category_id,u.id)};for(const s of n||[])o(s);return t}const k=xe(()=>{const n={};for(const t of x.value||[])n[t.id]={...t};for(const t of Object.values(n))if(t.parent_id&&(!t.category_id||t.category_id===null)){const o=n[t.parent_id];o&&(t.category_id=o.category_id)}return n}),F=(n,t)=>{const o=k.value[t];if(!o||!o.children?.length)return{subtotal:0,weighted:0};const s=o.children.reduce((i,u)=>{const a=m.value[`${n}-${u.id}`],h=a===""||a===null||a===void 0?0:Number(a);return isNaN(h)?i:i+h*(Number(u.percentage)/100)},0),e=s*Number(o.percentage)/100;return{subtotal:s,weighted:e}},de=(n,t)=>{const o=F(n,t),s=Number(o.weighted||0);return isNaN(s)?0:s},j=n=>{const t=x.value||[],o=new Set;for(const e of t)if(Array.isArray(e.children)&&e.children.length)for(const i of e.children)i?.id!=null&&o.add(Number(i.id));const s=t.filter(e=>e.category_id===n.id&&!o.has(Number(e.id)));return[{key:"number",label:"No."},{key:"municipality",label:"Municipality"},...s.map(e=>({key:`crit_${e.id}`,label:`${e.name} (${Number(e.percentage)}%)`,raw:!0})),{key:"total",label:"Total"}]},K=(n,t)=>{const o=(P.value||[]).filter(a=>(a.gender||"").toLowerCase()===t.toLowerCase()),s=a=>({id:a.id,number:a.number,municipality:a.municipality??a.lgu??a.lgu_name??""});if(!ie(n))return o.map(s);const e=re(t),i=T.finalists?.[e]??[];if(!i.length)return[];const u=i.map(a=>a.contestant_id);return o.filter(a=>u.includes(a.id)).map(s)},O=(n,t)=>x.value.filter(e=>e.category_id===t).reduce((e,i)=>{if(i.children?.length)return e+de(n,i.id);if(!i.parent_id){const u=`${n}-${i.id}`,a=Number(m.value[u]||0);return e+a*(Number(i.percentage)/100)}return e},0).toFixed(5),oe=Be({required_error:"Score is required",invalid_type_error:"Must be a number"}).min(60,{message:"Minimum is 60"}).max(100,{message:"Maximum is 100"}),ue=n=>{if(!x.value?.length)return!1;const t=(E.value||[]).find(e=>e.id===n);if(!t)return!1;const o=x.value.filter(e=>{const i=x.value.some(h=>h.parent_id===e.id),u=e.parent_id?k.value[e.parent_id]:null;return(e.category_id===n||u?.category_id===n)&&!i});if(!o.length)return!1;const s=["female","male"];for(const e of s){const i=K(t,e);if(i.length)for(const u of i)for(const a of o){const h=`${u.id}-${a.id}`,N=m.value[h];if(N==null||N==="")return!1;const v=Number(N);if(isNaN(v)||!oe.safeParse(v).success)return!1}}return!0},ce=async n=>{if(S.value){B.value=!0;try{const t=x.value.filter(e=>{const i=x.value.some(h=>h.parent_id===e.id),u=e.parent_id?k.value[e.parent_id]:null;return(e.category_id===n.id||u?.category_id===n.id)&&!i}),o=[],s=[];for(const e of t)for(const i of P.value||[]){const u=`${i.id}-${e.id}`,a=m.value[u];if(a==null||a==="")continue;const h=Number(a);if(isNaN(h))continue;if(!oe.safeParse(h).success){s.push(`${i.name} (${e.name})`);continue}o.push({contestant_id:i.id,criterion_id:e.id,category_id:e.category_id,judge_id:Z.value?.id,score:h})}if(s.length>0){se.add({title:"Invalid Scores",description:`Please check these entries:
${s.join(", ")}`,color:"red"});return}await T.bulkAddScores({event_id:S.value,scores:o}),se.add({title:`Scores for "${n.name}" saved successfully`,color:"green"})}finally{B.value=!1}}};return X(m,(n,t)=>{const o=(x.value||[]).filter(s=>s.children?.length);for(const s of o)for(const e of P.value||[]){const{subtotal:i,weighted:u}=F(e.id,s.id);if(!isFinite(u))continue;const a=`${e.id}-${s.id}`;m.value[a]=Number(u.toFixed(5))}},{deep:!0,immediate:!0}),X(m,()=>{H&&clearTimeout(H),H=setTimeout(()=>{const n={};for(const t of E.value||[])for(const o of P.value||[]){const s=O(o.id,t.id);n[`${o.id}-${t.id}`]=Number(s)}M.value=n},100)},{deep:!0}),X(S,async n=>{if(n){B.value=!0;try{await Promise.all([W.fetchPhasesByEvent(n),te.fetchCategoriesByEvent(n),ne.fetchCriteriaByEvent?.(n),ee.fetchContestantsByEvent?.(n),T.fetchScoresByEvent?.(n)]),await T.fetchFinalists({event_id:n,limit:5,category_slugs:["ethnic-wear","casual-interview","advocacy-pitch","swim-wear","talent","creative-wear","formal-wear"]}),x.value=le(x.value||[]),m.value={};for(const t of I.value)m.value[`${t.contestant_id}-${t.criterion_id}`]=t.score}finally{B.value=!1,I.value?.length||(m.value={})}}}),(n,t)=>{const o=me,s=_e,e=ve,i=fe,u=ke,a=Se,h=pe,N=Ne;return d(),c("div",Me,[f("div",Pe,[b(s,{label:"Select Active Event"},{default:$(()=>[b(o,{modelValue:S.value,"onUpdate:modelValue":t[0]||(t[0]=v=>S.value=v),options:V(R).map(v=>({label:v.title,value:v.id})),placeholder:"Choose event",class:"w-72"},null,8,["modelValue","options"])]),_:1})]),S.value&&V(D)?.length?(d(),c("div",je,[b(N,{items:V(D).map(v=>({label:v.name,icon:"i-heroicons-flag",slot:`phase-${v.id}`}))},L({_:2},[w(V(D),v=>({name:`phase-${v.id}`,fn:$(()=>[b(a,{class:"p-4 space-y-6"},{default:$(()=>[f("div",Ae,_(v.name),1),V(E).filter(r=>r.phase_id===v.id).length?(d(),Y(N,{key:0,items:V(E).filter(r=>r.phase_id===v.id).map(r=>({label:`${r.name} (${r.weight}%)`,icon:"i-heroicons-sparkles",slot:`category-${r.id}`}))},L({_:2},[w(V(E).filter(r=>r.phase_id===v.id),r=>({name:`category-${r.id}`,fn:$(()=>[b(h,{state:m.value,onSubmit:$e(()=>ce(r),["prevent"]),class:"space-y-4"},{default:$(()=>[b(a,{class:"p-4 space-y-4"},{default:$(()=>[f("div",Le,[z(_(r.name)+" ",1),f("span",ze,"("+_(r.weight)+"%)",1)]),f("div",null,[t[2]||(t[2]=f("div",{class:"font-medium mt-2 mb-2 text-pink-500"},"Female",-1)),b(i,{columns:j(r),rows:K(r,"female")},L({_:2},[w(j(r),p=>({name:p.key+"-data",fn:$(({row:l})=>[p.key==="number"?(d(),c("div",qe,_(l.number),1)):p.key==="municipality"?(d(),c("div",Ge,_(l.municipality),1)):p.key.startsWith("crit_")?(d(),c("div",Re,[b(s,{name:`${l.id}-${Number(p.key.split("_")[1])}`},{default:$(()=>[k.value[Number(p.key.split("_")[1])]?(d(!0),c(U,{key:0},w([Number(p.key.split("_")[1])],y=>(d(),c(U,{key:y},[k.value[y]?.children?.length?(d(),c("div",We,[f("div",De,_(F(l.id,y).weighted.toFixed(5)),1),f("div",He,[(d(!0),c(U,null,w(k.value[y].children,g=>(d(),c("div",{key:g.id,class:"flex items-center justify-between gap-2 py-0.5"},[f("span",Ke,_(g.name)+" ("+_(g.percentage)+"%)",1),b(e,{modelValue:m.value[`${l.id}-${g.id}`],"onUpdate:modelValue":Q=>m.value[`${l.id}-${g.id}`]=Q,type:"number",step:"0.1",size:"2xs",class:"w-20 text-center"},null,8,["modelValue","onUpdate:modelValue"])]))),128)),f("div",Oe,[t[1]||(t[1]=z(" Subtotal: ",-1)),f("b",null,_(F(l.id,y).subtotal.toFixed(5)),1)])])])):(d(),Y(e,{key:1,modelValue:m.value[`${l.id}-${y}`],"onUpdate:modelValue":g=>m.value[`${l.id}-${y}`]=g,type:"number",step:"0.1",size:"xs",class:"w-20 text-center"},null,8,["modelValue","onUpdate:modelValue"]))],64))),128)):q("",!0)]),_:2},1032,["name"])])):p.key==="total"?(d(),c("div",{key:3,class:ae(["text-right font-semibold transition-all duration-300",{"text-green-600":M.value[`${l.id}-${r.id}`]!==void 0}])},_(M.value[`${l.id}-${r.id}`]?.toFixed(5)??O(l.id,r.id)),3)):q("",!0)])}))]),1032,["columns","rows"])]),f("div",null,[t[4]||(t[4]=f("div",{class:"font-medium mt-2 mb-2 text-blue-500"},"Male",-1)),b(i,{columns:j(r),rows:K(r,"male")},L({_:2},[w(j(r),p=>({name:p.key+"-data",fn:$(({row:l})=>[p.key==="number"?(d(),c("div",Qe,_(l.number),1)):p.key==="municipality"?(d(),c("div",Xe,_(l.municipality),1)):p.key.startsWith("crit_")?(d(),c("div",Ye,[b(s,{name:`${l.id}-${Number(p.key.split("_")[1])}`},{default:$(()=>[k.value[Number(p.key.split("_")[1])]?(d(!0),c(U,{key:0},w([Number(p.key.split("_")[1])],y=>(d(),c(U,{key:y},[k.value[y]?.children?.length?(d(),c("div",Je,[f("div",Ze,_(F(l.id,y).weighted.toFixed(5)),1),f("div",Ie,[(d(!0),c(U,null,w(k.value[y].children,g=>(d(),c("div",{key:g.id,class:"flex items-center justify-between gap-2 py-0.5"},[f("span",et,_(g.name)+" ("+_(g.percentage)+"%)",1),b(e,{modelValue:m.value[`${l.id}-${g.id}`],"onUpdate:modelValue":Q=>m.value[`${l.id}-${g.id}`]=Q,type:"number",step:"0.1",size:"2xs",class:"w-20 text-center"},null,8,["modelValue","onUpdate:modelValue"])]))),128)),f("div",tt,[t[3]||(t[3]=z(" Subtotal: ",-1)),f("b",null,_(F(l.id,y).subtotal.toFixed(5)),1)])])])):(d(),Y(e,{key:1,modelValue:m.value[`${l.id}-${y}`],"onUpdate:modelValue":g=>m.value[`${l.id}-${y}`]=g,type:"number",step:"0.1",size:"xs",class:"w-20 text-center"},null,8,["modelValue","onUpdate:modelValue"]))],64))),128)):q("",!0)]),_:2},1032,["name"])])):p.key==="total"?(d(),c("div",{key:3,class:ae(["text-right font-semibold transition-all duration-300",{"text-green-600":M.value[`${l.id}-${r.id}`]!==void 0}])},_(M.value[`${l.id}-${r.id}`]?.toFixed(5)??O(l.id,r.id)),3)):q("",!0)])}))]),1032,["columns","rows"])]),f("div",nt,[b(u,{type:"submit",color:"primary",icon:"i-heroicons-check-circle",loading:B.value,disabled:!ue(r.id)},{default:$(()=>[z(" Save Scores for "+_(r.name),1)]),_:2},1032,["loading","disabled"])])]),_:2},1024)]),_:2},1032,["state","onSubmit"])])}))]),1032,["items"])):(d(),c("div",st," No categories found under this phase. "))]),_:2},1024)])}))]),1032,["items"])])):(d(),c("div",ot," Please select an event to begin scoring. "))])}}});export{kt as default};
